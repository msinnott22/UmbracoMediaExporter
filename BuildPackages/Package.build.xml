<?xml version="1.0" encoding="utf-8" ?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" DefaultTargets="Package">

    <PropertyGroup>
        <MSBuildCommunityTasksPath>$(MSBuildProjectDirectory)\Tools\MSBuildCommunityTasks</MSBuildCommunityTasksPath>
        <MSBuildUmbracoTasksPath>$(MSBuildProjectDirectory)\Tools\MSBuildUmbracoTasks</MSBuildUmbracoTasksPath>
        <MSBuildNugetTasksPath>$(MSBuildProjectDirectory)\Tools\MSBuildNugetTasks</MSBuildNugetTasksPath>
    </PropertyGroup>

    <Import Project="$(MSBuildCommunityTasksPath)\MSBuild.Community.Tasks.Targets" />
    <Import Project="$(MSBuildUmbracoTasksPath)\MSBuild.Umbraco.Tasks.Targets" />
    <Import Project="$(MSBuildNugetTasksPath)\MSBuild.NuGet.Tasks.Targets" />

    <!-- PROPERTIES -->
    <!-- SHARED PROPERTIES -->
    <PropertyGroup>
        <PackageName>Media Exporter</PackageName>
        <MinUmbracoVersion>7.9.2</MinUmbracoVersion>
        <Readme>Export Media Folders</Readme>
        <AuthorName>Michael Sinnott</AuthorName>
        <AuthorUrl>http://www.michaelsinnott.co.uk<AuthorUrl>
        <PackageLicenseName>MIT License</PackageLicenseName>
        <PackageLicenseUrl>http://www.opensource.org/licenses/mit-license.php</PackageLicenseUrl>
        <ProjectUrl>http://www.michaelsinnott.co.uk</ProjectUrl>
    </PropertyGroup>

    <!-- NUGET ONLY PROPERTIES -->
    <PropertyGroup>
        <NugetPackageName>Media Exporter</NugetPackageName>
        <PackageId>UmbracoMediaExporter.MediaExporter</PackageId>
        <Copyright>Michael Sinnott</Copyright>
        <Owners>Michael Sinnott</Owners>
        <Summary>Export Media Folders</Summary>
        <Tags>umbraco</Tags>
        <Language>en-GB</Language>
        <RequireLicenseAcceptance>false</RequireLicenseAcceptance>
    </PropertyGroup>

    <PropertyGroup>
        <VersionMajor>1</VersionMajor>
        <VersionMinor>0</VersionMinor>
        <VersionPatch>0</VersionPatch>
        <VersionSuffix>-beta</VersionSuffix>
        <UmbracoVersion>7.9.2</UmbracoVersion>
    </PropertyGroup>

    <PropertyGroup>
        <RootDir>$(MSBuildProjectDirectory)</RootDir>
        <PackageDir>$(RootDir)\..\Releases</PackageDir>
        <BuildUmbDir>$(MSBuildProjectDirectory)\_umbraco</BuildUmbDir>
        <BuildNuGetDir>$(MSBuildProjectDirectory)\_nuget</BuildNuGetDir>
        <CoreProjectDir>$(RootDir)\..\MediaExporter\</CoreProjectDir>
        <AppPluginUmbDir>$(BuildUmbDir)\App_Plugins\MediaExporter</AppPluginUmbDir>
    </PropertyGroup>

    <!-- CLEAN -->
    <Target Name="Clean">
        <RemoveDir Directories="$(BuildUmbDir)" Condition="Exists('$(BuildUmbDir)')" />
        <RemoveDir Directories="$(BuildNuGetDir)" Condition="Exists('$(BuildNuGetDir)')" />
        <MakeDir Directories="$(BuildUmbDir)" />
        <MakeDir Directories="$(BuildNuGetDir)" />
        <MakeDir Directories="$(PackageDir)" />
        <MakeDir Directories="$(AppPluginUmbDir)" />
    </Target>

    <!-- UPDATE ASSEMBLEY VERSION -->
    <Target Name="UpdateAssemblyInfo" DependsOnTarget="Clean">
        <Version Major="$(VersionMajor)" Minor="$(VersionMinor)" BuildType="Automatic" RevisionType="Automatic" StartDate="01/04/2018">
            <Output TaskParameter="Build" PropertyName="Build" />
            <Output TaskParameter="Revision" PropertyName="Revision" />
        </Version>
            
        <PropertyGroup>
            <FileVersion>$(VersionMajor).$(VersionMinor).$(VersionPatch).$(Build)</FileVersion>
            <ProductVersion>$(VersionMajor).$(VersionMinor).$(VersionPatch)$(VersionSuffix)</ProductVersion>
        </PropertyGroup>
        
        <FileUpdate Encoding="ASCII" Files="$(CoreProjectDir)\Properties\AssemblyInfo.cs" Regex="AssemblyVersion\(&quot;.*&quot;\)\]" ReplacementText="AssemblyVersion(&quot;$(FileVersion)&quot;)]" />
        <FileUpdate Encoding="ASCII" Files="$(CoreProjectDir)\Properties\AssemblyInfo.cs" Regex="AssemblyFileVersion\(&quot;.*&quot;\)\]" ReplacementText="AssemblyFileVersion(&quot;$(FileVersion)&quot;)]" />
        <FileUpdate Encoding="ASCII" Files="$(CoreProjectDir)\Properties\AssemblyInfo.cs" Regex="AssemblyInformationalVersion\(&quot;.*&quot;\)\]" ReplacementText="AssemblyInformationalVersion(&quot;$(ProductVersion)&quot;)]" />
    </Target>

    <!-- COMPILE -->
    <Target Name="Compile" DependsOnTarget="UpdateAssemblyInfo">
        <MSBuild Projects="$(CoreProjectDir)\MediaExporter.csproj" />
    </Target>

    <!-- PREPARE FILES -->
    <Target Name="PrepareFiles" DependsOnTarget="Compile">
        <IteamGroup>
            <PackageFile Include="$(RootDir)\Package.xml" />
            <BinFiles Include="$(CoreProjectDir)\bin\**\MediaExporter.dll" />
            <ScriptFiles Include="$(CoreProjectDir)\App_Plugins\MediaExporter\backOffice\controllers\*.*" />
            <ScriptFiles Include="$(CoreProjectDir)\App_Plugins\MediaExporter\backOffice\resources\*.*" />
            <ScriptFiles Include="$(CoreProjectDir)\App_Plugins\MediaExporter\backOffice\node_modules\angular-file-saver\dist\angular-file-saver.bundle.js" />
            <ViewFiles Include="$(CoreProjectDir)\App_Plugins\MediaExporter\backOffice\Dialogs\*.*" />
            <NuSpecFile Include="$(MSBuildProjectDirectory)\package.nuspec" />
	        <NugetReadmeFile Include="$(MSBuildProjectDirectory)\readme.txt" />
            <NugetXdtTransformFile Include="$(MSBuildProjectDirectory)\web.config.install.xdt" />
        </IteamGroup>

        <Copy SourceFiles="@(NuSpecFile)" DestinationFolder="$(BuildNuGetDir)" />
        <Copy SourceFiles="@(PackageFile)" DestinationFolder="$(BuildUmbDir)" >
        <Copy SourceFiles="@(ConfigFiles)" DestinationFolder="$(AppPluginUmbDir)" />
        <Copy SourceFiles="@(ScriptFiles)" DestinationFolder="$(AppPluginUmbDir)\js\" />
        <!-- <Copy SourceFiles="@(StyleFiles)" DestinationFolder="$(AppPluginUmbDir)\css\" /> -->
        <Copy SourceFiles="@(ViewFiles)" DestinationFolder="$(AppPluginUmbDir)\backOffice\Dialogs\" />
        <Copy SourceFiles="@(BinFiles)" DestinationFolder="@(BinFiles->'$(BuildUmbDir)\bin\%(RecursiveDir)%(Filename)%(Extension)'" />
        <Copy SourceFiles="@(NugetXdtTransformFile)" DestinationFolder="$(BuildNuGetDir)\Content\" />
        <Copy SourceFiles="@(NugetReadmeFile)" DestinationFolder="$(BuildNuGetDir)\" />
        <Copy SourceFiles="@(ConfigFiles)" DestinationFolder="$(BuildNuGetDir)\Content\App_Plugins\MediaExporter\" />
        <Copy SourceFiles="@(ScriptsFiles)" DestinationFolder="$(BuildNuGetDir)\Content\App_Plugins\MediaExporter\js\" />
        <Copy SourceFiles="@(ViewFiles)" DestinationFolder="$(BuildNuGetDir)\Content\App_Plugins\MediaExporter\backOffice\Dialogs\" />
        <Copy SourceFiles="@(BinFiles)" DestinationFolder="@(BinFiles->'$(BuildNuGetDir)\lib\%(RecursiveDir)%(Filename)%(Extension)')" />
        <!-- <Copy SourceFiles="@()" DestinationFolder="" />
        <Copy SourceFiles="@()" DestinationFolder="" /> -->

    </Target>

    <!-- UMBRACO MANIFEST -->
    <Target Name="UmbracoManifest" DependsOnTarget="PrepareFiles">
        <ItemGroup>
            <ManifestFiles Include="$(BuildUmbDir)\**\*" Exclude="$(BuildUmbDir)\package.xml" />
        </ItemGroup>
        <ManifestUpdate ManifestFile="$(BuildUmbDir)\package.xml"
            WorkingDirectory="$(BuildUmbDir)"
            MinimumRequiredUmbracoVersion="$(UmbracoVersion)"
            PackageVersion="$(VersionMajor).$(VersionMinor).$(VersionPatch)$(VersionSuffix)"
            Files="@(ManifestFiles)"  />
    </Target>
    <!-- NUGET PACKAGE MANIFEST -->
    <Target Name="NuGetManifest" DependsOnTarget="PrepareFiles">
       <ItemGroup> 
        <ManifestFiles Include="$(BuildNuGetDir)\**\*" Exclude="$(BuildNuGetDir)\package.nuspec" />
       </ItemGroup>
       <MSBuild.NuGet.Tasks.ManifestUpdate 
            ManifestFile="$(BuildNuGetDir)\package.nuspec"
            WorkingDirectory="$(BuildNuGetDir)"
            Title="$(NugetPackageName)"
            Description="$(Readme)"
            Summary="$(Summary)"
            Version=""
            MinimumRequiredUmbracoVersion="$(MinUmbracoVersion)"
            Authors=""
            Owners=""
            Copyright=""
            LicenseUrl="$(PackageLicenseUrl)"
			ProjectUrl="$(ProjectUrl)"
			Id="$(PackageId)"
			IconUrl="$(IconUrl)"
			Language="$(Language)"
			RequireLicenseAcceptance="$(RequireLicenseAcceptance)"
			Tags="$(Tags)"
			Files="@(ManifestFiles)" />
    </Target>
    <!-- PACKAGE -->
	<Target Name="Package" DependsOnTargets="Manifest; ManifestNuGet">
		<ItemGroup>
			<PackageFiles Include="$(BuildUmbDir)\**\*.*" />
		</ItemGroup>
		
		<Package ManifestFile="$(BuildUmbDir)\Package.xml"
			WorkingDirectory="$(BuildUmbDir)"
			OutputDirectory="$(PackageDir)"
			Files="@(PackageFiles)" />
			
		<MSBuild.NuGet.Tasks.Pack NuGetExePath="$(RootDir)\Tools\NuGet.exe"
          ManifestFile="$(BuildNuGetDir)\package.nuspec"
          BasePath="$(BuildNuGetDir)"
          Version="$(ProductVersion)"
          OutputDirectory="$(PackageDir)"
          Symbols="true" />
		  
        <RemoveDir Directories="$(BuildUmbDir)" Condition="Exists('$(BuildUmbDir)')" />
		<RemoveDir Directories="$(BuildNuGetDir)" Condition="Exists('$(BuildNuGetDir)')" />
	</Target>


</ProjectUrl>